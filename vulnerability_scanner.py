# --- File: vulnerability_scanner.py (PHIÊN BẢN NÂNG CẤP) ---
import re

PATTERNS = {
    "WebView - Javascript được bật (Nguy cơ XSS)": re.compile(b'setJavaScriptEnabled', re.IGNORECASE),
    "Sử dụng HTTP không an toàn": re.compile(b'http://'),
    "Sử dụng bộ nhớ ngoài (External Storage)": re.compile(b'getExternalStorageDirectory|getExternalFilesDir'),
    "Dấu hiệu lưu trữ không mã hóa (SharedPreferences)": re.compile(b'getSharedPreferences'),
    "Dấu hiệu thông tin nhạy cảm bị hardcode": re.compile(b'apikey|secret|password|token', re.IGNORECASE)
}

# --- Phần code còn lại của file giữ nguyên ---
def scan_for_vulnerabilities(dvm_format):
    """Quét mã nguồn DEX để tìm các mẫu code không an toàn."""
    findings = {}
    
    try:
        all_strings = dvm_format.get_strings()
    except Exception:
        all_strings = []

    for key, pattern in PATTERNS.items():
        count = 0
        for s in all_strings:
            if isinstance(s, bytes) and pattern.search(s):
                count += 1
        if count > 0:
            findings[key] = f"{count} lần xuất hiện"
            
    return findings